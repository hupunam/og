#!/bin/bash

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
PURPLE='\033[0;35m'
WHITE='\033[1;37m'
NC='\033[0m' # No Color

# Graceful exit function
graceful_exit() {
    echo ""
    echo ""
    echo -e "${GREEN}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
    echo -e "${GREEN}‚ïë                        üëã Thank You! üëã                          ‚ïë${NC}"
    echo -e "${GREEN}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
    echo ""
    echo -e "${CYAN}üôè Thank you for using Testnet Terminal's OneClick Setup!${NC}"
    echo ""
    echo -e "${YELLOW}üîó Stay Connected:${NC}"
    echo -e "${BLUE}üì± Telegram: ${NC}https://t.me/TestnetTerminal"
    echo -e "${BLUE}üêô GitHub: ${NC}https://github.com/TestnetTerminal" 
    echo -e "${BLUE}üê¶ Twitter: ${NC}https://x.com/TestnetTerminal"
    echo -e "${BLUE}üÜò Support: ${NC}https://t.me/Amit3701"
    echo ""
    echo -e "${GREEN}‚ú® Happy Testing! See you next time! ‚ú®${NC}"
    echo ""
    exit 0
}

# Set trap to catch Ctrl+C and other signals
trap 'graceful_exit' INT TERM

# Function to print colored output
print_status() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

print_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

print_success() {
    echo -e "${CYAN}[SUCCESS]${NC} $1"
}

# Display main banner
show_banner() {
    clear
    echo ""
    echo -e "${BLUE}‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó    ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïó     ${NC}"
    echo -e "${BLUE}‚ïö‚ïê‚ïê‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïê‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïê‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù    ‚ïö‚ïê‚ïê‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë     ${NC}"
    echo -e "${BLUE}   ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïî‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó     ‚ñà‚ñà‚ïë          ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïî‚ñà‚ñà‚ñà‚ñà‚ïî‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë     ${NC}"
    echo -e "${BLUE}   ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù  ‚ïö‚ïê‚ïê‚ïê‚ïê‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù     ‚ñà‚ñà‚ïë          ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù  ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë     ${NC}"
    echo -e "${BLUE}   ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë ‚ïö‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ïë          ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë ‚ïö‚ïê‚ïù ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë ‚ïö‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó${NC}"
    echo -e "${BLUE}   ‚ïö‚ïê‚ïù   ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù   ‚ïö‚ïê‚ïù   ‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù   ‚ïö‚ïê‚ïù          ‚ïö‚ïê‚ïù   ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïù     ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
    echo ""
    echo -e "${WHITE}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
    echo -e "${WHITE}‚ïë            üéâ Thank you for using our One-Click Setup! üéâ       ‚ïë${NC}"
    echo -e "${WHITE}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
    echo ""
    echo -e "${CYAN}üîó Our Links:${NC}"
    echo -e "${YELLOW}üì± Telegram: ${NC}https://t.me/TestnetTerminal"
    echo -e "${YELLOW}üêô GitHub: ${NC}https://github.com/TestnetTerminal"
    echo -e "${YELLOW}üê¶ Twitter/X: ${NC}https://x.com/TestnetTerminal"
    echo -e "${YELLOW}üÜò Support: ${NC}https://t.me/Amit3701"
    echo ""
}

# Display menu
show_menu() {
    echo -e "${WHITE}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
    echo -e "${WHITE}‚ïë             üöÄ 0G Storage Node OneClick Setup by Amit            ‚ïë${NC}"
    echo -e "${WHITE}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
    echo ""
    echo -e "${CYAN}Please select an option:${NC}"
    echo ""
    echo -e "${YELLOW}1. üõ†Ô∏è  Install 0G Storage Node${NC}"
    echo -e "${RED}2. üóëÔ∏è  Stop & Delete 0G Storage Node${NC}"
    echo -e "${PURPLE}3. üì• Download Snapshot (Faster Sync)${NC}"
    echo -e "${RED}4. ‚ùå Exit${NC}"
    echo ""
    echo -n -e "${WHITE}Select an option (1-4): ${NC}"
}

# Function to check current block sync status
check_block_sync() {
    local timeout=30
    local count=0
    
    print_status "üîç Checking block sync status..."
    
    while [ $count -lt $timeout ]; do
        if response=$(curl -s -X POST http://localhost:5678 -H "Content-Type: application/json" -d '{"jsonrpc":"2.0","method":"zgs_getStatus","params":[],"id":1}' 2>/dev/null); then
            if logSyncHeight=$(echo "$response" | jq -r '.result.logSyncHeight' 2>/dev/null) && [ "$logSyncHeight" != "null" ] && [ "$logSyncHeight" -gt 0 ] 2>/dev/null; then
                connectedPeers=$(echo "$response" | jq -r '.result.connectedPeers' 2>/dev/null)
                echo -e "${GREEN}‚úÖ Node is syncing!${NC}"
                echo -e "${CYAN}üìä Current Block: ${NC}$logSyncHeight"
                echo -e "${CYAN}üë• Connected Peers: ${NC}$connectedPeers"
                return 0
            fi
        fi
        
        count=$((count + 1))
        echo -n "."
        sleep 1
    done
    
    echo -e "\n${YELLOW}‚ö†Ô∏è Unable to get sync status (node may still be starting)${NC}"
    return 1
}

# Function to monitor block sync with auto-stop
monitor_block_sync() {
    local target_block=${1:-5611223}
    local stop_monitoring=false
    
    echo -e "${CYAN}üîÑ Monitoring block sync (will auto-stop at block $target_block)...${NC}"
    echo -e "${YELLOW}‚ö†Ô∏è Press Ctrl+C to stop monitoring manually${NC}"
    echo ""
    
    while [ "$stop_monitoring" = false ]; do
        if response=$(curl -s -X POST http://localhost:5678 -H "Content-Type: application/json" -d '{"jsonrpc":"2.0","method":"zgs_getStatus","params":[],"id":1}' 2>/dev/null); then
            if logSyncHeight=$(echo "$response" | jq -r '.result.logSyncHeight' 2>/dev/null) && [ "$logSyncHeight" != "null" ] && [ "$logSyncHeight" -gt 0 ] 2>/dev/null; then
                connectedPeers=$(echo "$response" | jq -r '.result.connectedPeers' 2>/dev/null)
                echo -e "\r${CYAN}üìä Block: ${NC}$logSyncHeight ${CYAN}| Peers: ${NC}$connectedPeers                    "
                
                # Check if we've reached the target block
                if [ "$logSyncHeight" -ge "$target_block" ]; then
                    echo ""
                    print_success "üéâ Reached block $target_block! Stopping monitoring..."
                    stop_monitoring=true
                fi
            else
                echo -e "\r${YELLOW}‚ö†Ô∏è Waiting for sync to start...                    "
            fi
        else
            echo -e "\r${RED}‚ùå Cannot connect to node API...                    "
        fi
        
        sleep 5
    done
}

# Install 0G Storage Node
install_og_storage_node() {
    echo ""
    echo -e "${PURPLE}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
    echo -e "${PURPLE}‚ïë                  üõ†Ô∏è Installing 0G Storage Node üõ†Ô∏è               ‚ïë${NC}"
    echo -e "${PURPLE}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
    echo ""

    # Check if node already exists
    if [ -d "$HOME/0g-storage-node" ]; then
        print_warning "‚ö†Ô∏è 0G Storage Node directory already exists!"
        echo ""
        echo -n -e "${WHITE}Do you want to continue and overwrite? (y/N): ${NC}"
        read -r overwrite_confirm
        case "${overwrite_confirm,,}" in
            y|yes)
                print_status "üîÑ Removing existing installation..."
                sudo systemctl stop zgs 2>/dev/null || true
                sudo systemctl disable zgs 2>/dev/null || true
                sudo rm -f /etc/systemd/system/zgs.service 2>/dev/null || true
                rm -rf "$HOME/0g-storage-node"
                print_success "‚úÖ Existing installation removed"
                ;;
            *)
                print_status "‚ùå Installation cancelled by user"
                read -p "Press Enter to return to main menu..."
                return
                ;;
        esac
    fi

    print_status "üì¶ Updating system and installing dependencies..."
    sudo apt-get update && sudo apt-get upgrade -y

    print_status "üì¶ Installing required packages..."
    sudo apt install curl iptables build-essential git wget lz4 jq make protobuf-compiler cmake gcc nano automake autoconf tmux htop nvme-cli libgbm1 pkg-config libssl-dev libleveldb-dev tar clang bsdmainutils ncdu unzip libleveldb-dev screen ufw -y

    # Install Rust
    if ! command -v rustc &>/dev/null; then
        print_status "ü¶Ä Installing Rustup..."
        curl https://sh.rustup.rs -sSf | sh -s -- -y
        source "$HOME/.cargo/env"
    else
        print_success "‚úÖ Rust is already installed ($(rustc --version))"
        source "$HOME/.cargo/env" 2>/dev/null || true
    fi

    # Install Go
    if ! command -v go &>/dev/null; then
        print_status "üêπ Installing Go..."
        wget https://go.dev/dl/go1.24.3.linux-amd64.tar.gz
        sudo rm -rf /usr/local/go
        sudo tar -C /usr/local -xzf go1.24.3.linux-amd64.tar.gz
        rm go1.24.3.linux-amd64.tar.gz
        echo 'export PATH=$PATH:/usr/local/go/bin' >> ~/.bashrc
        export PATH=$PATH:/usr/local/go/bin
    else
        print_success "‚úÖ Go is already installed ($(go version))"
    fi

    print_status "üìÅ Cloning 0G Storage Node repository..."
    git clone https://github.com/0glabs/0g-storage-node.git
    cd "$HOME/0g-storage-node"
    git checkout v1.1.0
    git submodule update --init

    print_status "üî® Building in release mode (this may take several minutes)..."
    cargo build --release

    print_status "‚öôÔ∏è Setting up configuration..."
    rm -rf "$HOME/0g-storage-node/run/config.toml"
    curl -o "$HOME/0g-storage-node/run/config.toml" https://raw.githubusercontent.com/Mayankgg01/0G-Storage-Node-Guide/main/config.toml

    # Get private key from user
    echo ""
    echo -e "${YELLOW}üîë Private Key Configuration${NC}"
    echo -e "${CYAN}Please enter your wallet's private key:${NC}"
    echo -e "${RED}‚ö†Ô∏è Do NOT include '0x' prefix${NC}"
    echo -e "${YELLOW}üí° Your private key will be securely added to config.toml${NC}"
    echo ""
    echo -n -e "${WHITE}Enter Private Key: ${NC}"
    read -r -s PRIVATE_KEY
    echo ""
    
    if [ -z "$PRIVATE_KEY" ]; then
        print_error "‚ùå Private key cannot be empty!"
        read -p "Press Enter to return to main menu..."
        return
    fi

    # Remove 0x prefix if present
    PRIVATE_KEY=$(echo "$PRIVATE_KEY" | sed 's/^0x//')

    # Update config.toml with private key
    sed -i "s/miner_key = \"\"/miner_key = \"$PRIVATE_KEY\"/" "$HOME/0g-storage-node/run/config.toml"
    print_success "‚úÖ Private key successfully added to config.toml"

    # Ask about RPC endpoint
    echo ""
    echo -e "${YELLOW}üåê RPC Endpoint Configuration${NC}"
    echo -e "${CYAN}Do you want to use a custom RPC endpoint?${NC}"
    echo -e "${GREEN}Press Enter or 'y' to use official RPC${NC}"
    echo -e "${YELLOW}Enter custom RPC URL to use custom endpoint${NC}"
    echo ""
    echo -n -e "${WHITE}RPC Endpoint (or press Enter for official): ${NC}"
    read -r RPC_ENDPOINT

    if [ -n "$RPC_ENDPOINT" ] && [ "$RPC_ENDPOINT" != "y" ] && [ "$RPC_ENDPOINT" != "Y" ]; then
        # Update config with custom RPC
        sed -i "s|blockchain_rpc_endpoint = \".*\"|blockchain_rpc_endpoint = \"$RPC_ENDPOINT\"|" "$HOME/0g-storage-node/run/config.toml"
        print_success "‚úÖ Custom RPC endpoint configured: $RPC_ENDPOINT"
    else
        print_success "‚úÖ Using official RPC endpoint"
    fi

    print_status "‚öôÔ∏è Creating systemd service..."
    sudo tee /etc/systemd/system/zgs.service > /dev/null <<EOF
[Unit]
Description=ZGS Node
After=network.target

[Service]
User=$USER
WorkingDirectory=$HOME/0g-storage-node/run
ExecStart=$HOME/0g-storage-node/target/release/zgs_node --config $HOME/0g-storage-node/run/config.toml
Restart=on-failure
RestartSec=10
LimitNOFILE=65535

[Install]
WantedBy=multi-user.target
EOF

    sudo systemctl daemon-reload
    sudo systemctl enable zgs

    print_status "üöÄ Starting 0G Storage Node..."
    sudo systemctl start zgs

    print_success "‚úÖ 0G Storage Node service started!"
    echo ""
    print_status "‚è≥ Waiting 5 seconds for node to initialize..."
    sleep 5

    # Check if sync started
    if check_block_sync; then
        echo ""
        echo -e "${YELLOW}üì• Snapshot Download Option${NC}"
        echo -e "${CYAN}Your node is syncing from block 0. This may take several days.${NC}"
        echo -e "${GREEN}We recommend downloading a snapshot for faster sync!${NC}"
        echo ""
        echo -e "${YELLOW}Choose an option:${NC}"
        echo -e "${GREEN}A) Download snapshot (recommended - starts from block 5,611,223)${NC}"
        echo -e "${BLUE}B) Continue from scratch (slower but complete sync)${NC}"
        echo ""
        echo -n -e "${WHITE}Your choice (A/B): ${NC}"
        read -r snapshot_choice

        case "${snapshot_choice,,}" in
            a|"")
                download_snapshot
                ;;
            b)
                print_status "‚úÖ Continuing with full sync from genesis block"
                echo ""
                print_success "üéâ 0G Storage Node successfully installed and running!"
                ;;
        esac
    else
        print_warning "‚ö†Ô∏è Node may still be starting up. Please check manually later."
    fi

    echo ""
    echo -e "${GREEN}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
    echo -e "${GREEN}‚ïë                    üéâ Installation Complete! üéâ                 ‚ïë${NC}"
    echo -e "${GREEN}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
    echo ""
    echo -e "${CYAN}üìã Useful Commands:${NC}"
    echo -e "${YELLOW}sudo systemctl status zgs${NC}          # Check service status"
    echo -e "${YELLOW}sudo systemctl restart zgs${NC}         # Restart service"
    echo -e "${YELLOW}tail -f ~/0g-storage-node/run/log/zgs.log.\$(TZ=UTC date +%Y-%m-%d)${NC}  # View logs"
    echo ""
    echo -e "${PURPLE}ü§ñ Get Transaction & Reward Notifications:${NC}"
    echo -e "${BLUE}üì± Telegram Bot: ${NC}https://t.me/og_tracker_bot"
    echo ""
    echo -e "${GREEN}‚ú® Thank you for using Testnet Terminal's OneClick Setup! ‚ú®${NC}"
    echo ""

    read -p "Press Enter to return to main menu..."
}

# Stop and Delete 0G Storage Node
delete_og_storage_node() {
    echo ""
    echo -e "${RED}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
    echo -e "${RED}‚ïë                  üóëÔ∏è Delete 0G Storage Node üóëÔ∏è                   ‚ïë${NC}"
    echo -e "${RED}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
    echo ""
    
    print_warning "‚ö†Ô∏è This will completely remove 0G Storage Node from your system!"
    echo ""
    echo -e "${YELLOW}üìã What will be deleted:${NC}"
    echo "‚Ä¢ 0g-storage-node directory and all contents"
    echo "‚Ä¢ ZGS systemd service"
    echo "‚Ä¢ All synced blockchain data"
    echo "‚Ä¢ Configuration files"
    echo ""
    
    echo -n -e "${WHITE}‚ùì Are you sure you want to delete 0G Storage Node? (y/N): ${NC}"
    read -r delete_confirm
    
    case "${delete_confirm,,}" in
        y|yes)
            ;;
        *)
            print_status "‚úÖ Deletion cancelled. Your 0G Storage Node is safe!"
            echo ""
            read -p "Press Enter to return to main menu..."
            return
            ;;
    esac
    
    echo ""
    print_status "üóëÔ∏è Starting deletion process..."
    
    # Stop service
    if systemctl is-active --quiet zgs 2>/dev/null; then
        print_status "üîÑ Stopping ZGS service..."
        sudo systemctl stop zgs
        print_success "‚úÖ Service stopped"
    fi
    
    # Disable and remove service
    if systemctl is-enabled --quiet zgs 2>/dev/null; then
        print_status "üîÑ Disabling ZGS service..."
        sudo systemctl disable zgs
    fi
    
    if [ -f "/etc/systemd/system/zgs.service" ]; then
        print_status "üóëÔ∏è Removing service file..."
        sudo rm /etc/systemd/system/zgs.service
        sudo systemctl daemon-reload
        print_success "‚úÖ Service file removed"
    fi
    
    # Remove directory
    if [ -d "$HOME/0g-storage-node" ]; then
        print_status "üìÅ Removing 0g-storage-node directory..."
        rm -rf "$HOME/0g-storage-node"
        print_success "‚úÖ Directory removed"
    fi
    
    echo ""
    print_success "‚úÖ 0G Storage Node completely removed!"
    echo ""
    echo -e "${GREEN}üí° You can reinstall anytime using option 1${NC}"
    echo ""
    
    read -p "Press Enter to return to main menu..."
}

# Download Snapshot
download_snapshot() {
    echo ""
    echo -e "${PURPLE}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
    echo -e "${PURPLE}‚ïë                   üì• Download Snapshot üì•                       ‚ïë${NC}"
    echo -e "${PURPLE}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
    echo ""

    # Check if node exists and is running
    if [ ! -d "$HOME/0g-storage-node" ]; then
        print_error "‚ùå 0G Storage Node not found!"
        echo ""
        print_status "üí° Please install the node first using option 1"
        echo ""
        read -p "Press Enter to return to main menu..."
        return
    fi

    # Check current sync status
    print_status "üîç Checking current sync status..."
    
    if response=$(curl -s -X POST http://localhost:5678 -H "Content-Type: application/json" -d '{"jsonrpc":"2.0","method":"zgs_getStatus","params":[],"id":1}' 2>/dev/null); then
        if logSyncHeight=$(echo "$response" | jq -r '.result.logSyncHeight' 2>/dev/null) && [ "$logSyncHeight" != "null" ] && [ "$logSyncHeight" -gt 0 ] 2>/dev/null; then
            echo -e "${CYAN}üìä Current sync block: ${NC}$logSyncHeight"
            
            # Check if already past snapshot block
            if [ "$logSyncHeight" -gt 4000000 ]; then
                echo ""
                print_warning "‚ö†Ô∏è Your node has already synced to block $logSyncHeight"
                echo -e "${YELLOW}The snapshot starts from block 5,611,223${NC}"
                echo -e "${CYAN}In 1-2 days, you'll naturally reach that block anyway.${NC}"
                echo ""
                echo -n -e "${WHITE}Are you sure you want to delete current progress and use snapshot? (y/N): ${NC}"
                read -r snapshot_confirm
                case "${snapshot_confirm,,}" in
                    y|yes)
                        ;;
                    *)
                        print_status "‚úÖ Snapshot download cancelled. Keeping current progress."
                        echo ""
                        read -p "Press Enter to return to main menu..."
                        return
                        ;;
                esac
            fi
        fi
    fi

    print_status "‚è∏Ô∏è Stopping ZGS service..."
    sudo systemctl stop zgs
    sleep 3

    print_status "üóëÔ∏è Removing current flow_db..."
    rm -rf "$HOME/0g-storage-node/run/db/flow_db"

    print_status "üìÅ Creating snapshots directory..."
    mkdir -p "$HOME/snapshots"
    cd "$HOME/snapshots"

    print_status "üì• Downloading snapshot parts (this may take a while)..."
    echo -e "${CYAN}üìä Snapshot info: Block 5,611,223 | Size: ~several GB${NC}"
    
    # Download first part
    print_status "üì• Downloading part 1/2..."
    if ! wget -q --show-progress https://github.com/amibunny/0g-storage-node-guide/releases/download/snapshot-block-5611223/flow_db.part-aa; then
        print_error "‚ùå Failed to download snapshot part 1"
        print_status "üîÑ Restarting ZGS service..."
        sudo systemctl start zgs
        read -p "Press Enter to return to main menu..."
        return
    fi
    
    # Download second part
    print_status "üì• Downloading part 2/2..."
    if ! wget -q --show-progress https://github.com/amibunny/0g-storage-node-guide/releases/download/snapshot-block-5611223/flow_db.part-ab; then
        print_error "‚ùå Failed to download snapshot part 2"
        print_status "üîÑ Restarting ZGS service..."
        sudo systemctl start zgs
        read -p "Press Enter to return to main menu..."
        return
    fi

    print_status "üîó Combining snapshot parts..."
    cat flow_db.part-* > flow_db.tar.xz

    print_status "üì¶ Extracting snapshot..."
    tar -xJvf flow_db.tar.xz -C "$HOME/0g-storage-node/run/db/"

    print_status "üöÄ Restarting ZGS service..."
    sudo systemctl restart zgs

    print_success "‚úÖ Snapshot download and extraction completed!"
    echo ""
    print_status "‚è≥ Waiting 5 seconds for service to start..."
    sleep 5

    # Monitor sync and auto-stop when reached snapshot block
    if check_block_sync; then
        echo ""
        monitor_block_sync 5611223
        
        echo ""
        print_success "üéâ Snapshot installation completed successfully!"
        echo ""
        echo -e "${GREEN}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
        echo -e "${GREEN}‚ïë                      üéä All Done! üéä                            ‚ïë${NC}"
        echo -e "${GREEN}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
        echo ""
        echo -e "${CYAN}‚úÖ Your 0G Storage Node is now running from block 5,611,223!${NC}"
        echo ""
        echo -e "${PURPLE}ü§ñ Get Transaction & Reward Notifications:${NC}"
        echo -e "${BLUE}üì± Telegram Bot: ${NC}https://t.me/og_tracker_bot"
        echo ""
        echo -e "${GREEN}üôè Thank you for using Testnet Terminal's OneClick Setup!${NC}"
        echo ""
        
        # Auto exit after successful completion
        echo -e "${YELLOW}‚è∞ Exiting in 10 seconds...${NC}"
        for i in {10..1}; do
            echo -ne "\r${CYAN}Exiting in $i seconds... ${NC}"
            sleep 1
        done
        echo ""
        graceful_exit
    else
        print_warning "‚ö†Ô∏è Could not verify sync status. Please check manually."
    fi

    # Clean up
    print_status "üßπ Cleaning up snapshot files..."
    rm -rf "$HOME/snapshots"

    echo ""
    read -p "Press Enter to return to main menu..."
}

# Exit function
exit_script() {
    graceful_exit
}

# Main menu loop
main() {
    while true; do
        show_banner
        show_menu
        
        read -r choice
        
        case $choice in
            1)
                install_og_storage_node
                ;;
            2)
                delete_og_storage_node
                ;;
            3)
                download_snapshot
                ;;
            4)
                exit_script
                ;;
            *)
                echo ""
                print_error "‚ùå Invalid option. Please select 1-4."
                echo ""
                read -p "Press Enter to continue..."
                ;;
        esac
    done
}

# Initialize and run
main "$@"
